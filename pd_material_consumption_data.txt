create table IF NOT EXISTS public.pd_material_consumption_data (
  id uuid not null default gen_random_uuid (),
  header_id uuid not null,
  material_id uuid not null,
  material_name text not null,
  material_type text null,
  track_id text null,
  traceability_code text null,
  qty_available numeric null,
  qty_used numeric null,
  qty_balance numeric null,
  created_at timestamp with time zone null default now(),
  updated_at timestamp with time zone null default now(),
  lot_no text null,
  row_index integer null,
  bags_used numeric null,
  is_loose boolean null default false,
  constraint pd_material_consumption_data_pkey primary key (id),
  constraint fk_pmcd_header foreign KEY (header_id) references pd_material_consumption_records (id) on delete CASCADE
) TABLESPACE pg_default;

create index IF not exists idx_pmcd_header on public.pd_material_consumption_data using btree (header_id) TABLESPACE pg_default;

create index IF not exists idx_pmcd_material_track on public.pd_material_consumption_data using btree (material_id, track_id) TABLESPACE pg_default;

create index IF not exists idx_pmcd_traceability on public.pd_material_consumption_data using btree (traceability_code) TABLESPACE pg_default;

DROP TRIGGER IF EXISTS zero_previous_balances_trigger ON pd_material_consumption_data;
create trigger zero_previous_balances_trigger
after INSERT
or
update on pd_material_consumption_data for EACH row
execute FUNCTION trg_zero_previous_balances ();

DROP TRIGGER IF EXISTS refund_stock_on_delete_trigger ON pd_material_consumption_data;
create trigger refund_stock_on_delete_trigger
after DELETE on pd_material_consumption_data for EACH row
execute FUNCTION trg_refund_stock_on_delete ();

-- MIGRATION: DROP COLUMNS MOVED TO pd_daily_log
ALTER TABLE public.pd_material_consumption_data 
DROP COLUMN IF EXISTS produced_rolls,
DROP COLUMN IF EXISTS produced_kgs_actual,
DROP COLUMN IF EXISTS produced_kgs_std,
DROP COLUMN IF EXISTS rejected_rolls,
DROP COLUMN IF EXISTS rejected_kgs_actual,
DROP COLUMN IF EXISTS rejected_kgs_std,
DROP COLUMN IF EXISTS accepted_rolls_nos,
DROP COLUMN IF EXISTS accepted_rolls_actual,
DROP COLUMN IF EXISTS accepted_rolls_std,
DROP COLUMN IF EXISTS total_scrap,
DROP COLUMN IF EXISTS reject_transfer_data,
DROP COLUMN IF EXISTS reject_issued_data,
DROP COLUMN IF EXISTS downtime_log_data,
DROP COLUMN IF EXISTS downtime_description;

-- ALSO CLEAN UP HEADER TABLE IF NEEDED
ALTER TABLE public.pd_material_consumption_records
DROP COLUMN IF EXISTS downtime_summary;

-- 1. ENABLE RLS
ALTER TABLE public.pd_material_consumption_data ENABLE ROW LEVEL SECURITY;

-- 2. REVOKE PUBLIC ACCESS AND GRANT TO SUPABASE ROLES
REVOKE ALL ON public.pd_material_consumption_data FROM PUBLIC;
GRANT SELECT, INSERT, UPDATE, DELETE ON public.pd_material_consumption_data TO anon, authenticated, service_role;

-- 3. POLICY: ONLY AUTHENTICATED USERS MAY ACCESS AND MODIFY ROWS
DROP POLICY IF EXISTS pd_material_consumption_data_authenticated_access ON public.pd_material_consumption_data;
CREATE POLICY pd_material_consumption_data_authenticated_access 
  ON public.pd_material_consumption_data 
  FOR ALL 
  USING (auth.role() = 'authenticated') 
  WITH CHECK (auth.role() = 'authenticated');

-- 4. RELOAD SCHEMA
NOTIFY pgrst, 'reload schema';
