-- 1. DROP AND RECREATE (Ensures a clean state since you have no data to migrate)
DROP TABLE IF EXISTS public.pd_daily_log;

create table public.pd_daily_log (
  id uuid not null default gen_random_uuid (),
  header_id uuid not null,
  produced_rolls numeric null,
  produced_kgs_actual numeric null,
  produced_kgs_std numeric null,
  rejected_rolls numeric null,
  rejected_kgs_actual numeric null,
  rejected_kgs_std numeric null,
  accepted_rolls_nos numeric null,
  accepted_rolls_actual numeric null,
  accepted_rolls_std numeric null,
  total_scrap jsonb null default '{"process_scrap": 0, "resin_scrap": 0}'::jsonb,
  reject_transfer_data jsonb null default '[]'::jsonb,
  reject_issued_data jsonb null default '[]'::jsonb,
  downtime_log_data jsonb null default '[]'::jsonb,
  downtime_description text null,
  created_at timestamp with time zone null default now(),
  updated_at timestamp with time zone null default now(),
  constraint pd_daily_log_pkey primary key (id),
  constraint pd_daily_log_header_id_key unique (header_id),
  constraint fk_pdl_header foreign KEY (header_id) references pd_material_consumption_records (id) on delete CASCADE
) TABLESPACE pg_default;

-- 1. CLEANUP DUPLICATES (If any exist)
DELETE FROM public.pd_daily_log a USING (
      SELECT MIN(ctid) as keep_ctid, header_id
      FROM public.pd_daily_log
      GROUP BY header_id
      HAVING COUNT(*) > 1
) b
WHERE a.header_id = b.header_id
AND a.ctid != b.keep_ctid;

-- 2. ENSURE UNIQUE CONSTRAINT
ALTER TABLE public.pd_daily_log DROP CONSTRAINT IF EXISTS pd_daily_log_header_id_key;
ALTER TABLE public.pd_daily_log ADD CONSTRAINT pd_daily_log_header_id_key UNIQUE (header_id);

-- 3. ENABLE RLS
ALTER TABLE public.pd_daily_log ENABLE ROW LEVEL SECURITY;

-- 3. REVOKE PUBLIC ACCESS AND GRANT TO SUPABASE ROLES
REVOKE ALL ON public.pd_daily_log FROM PUBLIC;
GRANT USAGE ON SCHEMA public TO anon, authenticated, service_role;
GRANT SELECT, INSERT, UPDATE, DELETE ON public.pd_daily_log TO anon, authenticated, service_role;

-- 4. POLICY: ONLY AUTHENTICATED USERS MAY ACCESS AND MODIFY ROWS
DROP POLICY IF EXISTS pd_daily_log_authenticated_access ON public.pd_daily_log;
CREATE POLICY pd_daily_log_authenticated_access 
  ON public.pd_daily_log 
  FOR ALL 
  TO authenticated
  USING (true)
  WITH CHECK (true);

-- 5. CREATE INDEX
create index IF not exists idx_pdl_header on public.pd_daily_log using btree (header_id) TABLESPACE pg_default;

-- 6. RELOAD SCHEMA
NOTIFY pgrst, 'reload schema';
