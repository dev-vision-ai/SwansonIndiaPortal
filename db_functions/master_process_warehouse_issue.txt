
DECLARE
    resolved_id uuid;
    resolved_type text;
    resolved_name text;
    resolved_uom text;
    resolved_std_weight numeric;
    new_track_id text;
    id_prefix text;
    final_qty numeric;
    final_uom text;
    final_bags numeric; -- RESTORED
    -- VARIABLE FOR REQUISITION DATE
    hdr_requisition_date date;
BEGIN
    -- ONLY run if there is a quantity and a lot number
    IF NEW.issued_qty > 0 AND NEW.lot_no IS NOT NULL AND NEW.lot_no <> '' THEN

        -- 1. FETCH REQUISITION DATE FROM THE HEADER
        SELECT requisition_date INTO hdr_requisition_date
        FROM public.material_requisitions
        WHERE id = NEW.requisition_id;

        -- 2. LOOKUP MATERIAL (Your original code)
        SELECT id, material_category, material_name, uom, std_bag_weight
        INTO resolved_id, resolved_type, resolved_name, resolved_uom, resolved_std_weight
        FROM pd_material_catalog 
        WHERE material_name = NEW.description 
        LIMIT 1;

        -- 3. DETERMINE PREFIX (Your original CASE logic)
        CASE 
            WHEN resolved_type ILIKE 'Resin' OR resolved_type ILIKE 'Raw Material' THEN id_prefix := 'RM';
            WHEN resolved_type ILIKE 'Pallets' OR resolved_type ILIKE 'Core' OR resolved_type ILIKE 'Pack%' THEN id_prefix := 'PM';
            WHEN resolved_type ILIKE 'Ink' OR resolved_type ILIKE 'Print%' OR resolved_type ILIKE 'Reducer' OR resolved_type ILIKE 'Retarder' THEN id_prefix := 'PRT-MAT';
            ELSE id_prefix := 'GEN'; 
        END CASE;

        -- 4. GENERATE TRACK ID
        new_track_id := id_prefix || to_char(now(), 'YYMM') || '-' || substring(md5(random()::text) from 1 for 4);

        -- 5. CALCULATE QUANTITY MATH (Your original IF/ELSE logic)
        IF resolved_uom = 'Kgs' OR resolved_uom = 'KG' THEN
             final_qty := NEW.issued_qty;
             final_uom := 'Kgs';
        ELSIF (resolved_uom = 'Nos' OR resolved_uom = 'Bags') AND resolved_std_weight IS NOT NULL AND resolved_std_weight > 0 THEN
             final_qty := NEW.issued_qty * resolved_std_weight;
             final_uom := 'Kgs'; 
        ELSE
             final_qty := NEW.issued_qty;
             final_uom := 'Nos';
        END IF;

        -- 6. CALCULATE BAGS (RESTORED Internal Calculation)
        IF resolved_std_weight IS NOT NULL AND resolved_std_weight > 0 THEN
            final_bags := ROUND(final_qty / resolved_std_weight, 2);
        ELSE
            final_bags := 0;
        END IF;

        -- 7. INSERT (Uses NEW.uom and NEW.bags from your form)
        INSERT INTO pd_material_staging (
            track_id, 
            requisition_date, 
            issued_date, 
            material_id, 
            material_name, 
            material_type, 
            lot_no, 
            issued_qty, 
            balance_qty, 
            consumed_qty, 
            uom, 
            bags, 
            status, 
            is_active
        )
        VALUES (
            UPPER(new_track_id), 
            hdr_requisition_date, 
            CURRENT_DATE, 
            resolved_id, 
            resolved_name, 
            resolved_type, 
            NEW.lot_no, 
            final_qty, 
            final_qty, 
            0, 
            NEW.uom,   -- Pulls from your Items Table
            NEW.bags,  -- Pulls from your Items Table
            'Available', 
            true
        );
        
    END IF;
    RETURN NEW;
END;
